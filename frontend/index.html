<!doctype html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <title>CodePen - Animated Login Form using Html &amp; CSS Only</title>

    <link rel="stylesheet" href="./style.css">

</head>

<body> <!-- partial:index.partial.html -->

    <section> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span> <span></span>
        <span></span> <span></span> <span></span> <span></span> <span></span>

        <div id="signinPage" class="signin">

            <div class="content">

                <h2>Sign In</h2>

                <div class="form">

                    <div class="inputBox">

                        <input type="text" id="loginUsername" required> <i>Username</i>

                    </div>

                    <div class="inputBox">

                        <input type="password" id="loginPassword" required> <i>Password</i>

                    </div>

                    <div class="links"> <a href="#">Forgot Password</a> <a onclick="showRegistrationPage()"
                            href="#">Register</a>

                    </div>

                    <div class="inputBox">

                        <input onclick="login()" type="submit" value="Login">

                    </div>

                </div>

            </div>

        </div>

        <div id="registrationPage" class="registration" style="display: none;">

            <div class="content">

                <h2>Register</h2>

                <div class="form">

                    <div class="inputBox">

                        <input type="text" id="registerUsername" required> <i>Username</i>

                    </div>

                    <div class="inputBox">

                        <input type="password" id="registerPassword" required> <i>Password</i>

                    </div>

                    <div class="links"> <a href="#">Cancel</a> <a href="#">Sign In</a>

                    </div>

                    <div class="inputBox">

                        <input type="submit" onclick="register()" value="Confirm">

                    </div>

                </div>

            </div>

        </div>

        <div id="roomPage" class="roomPage" style="display: none;">

            <div class="content">

                <h2>Rooms Page</h2>

                <div class="form">

                    <div class="inputBox">

                        <input type="text" id="joinRoom" required> <i>Room Id</i>

                    </div>

                    <div class="inputBox">

                        <input type="submit" onclick="joinRoom()" value="New Room">

                    </div>

                </div>

            </div>

        </div>

        <div id="room" class="room" style="display: none;">
            <div class="content">
                <h2>Chat Room</h2>
                <div class="chat-box">
                    <div class="message-area" id="messageArea">
                        <div id="messages"></div>
                    </div>
                    <div class="inputBox">
                        <input type="text" id="message" placeholder="Type a message">
                        <button id="send">Send</button>
                    </div>
                </div>
                <div class="inputBox">
                    <button onclick="leaveRoom()">Leave Room</button>
                </div>
            </div>
        </div>

    </section> <!-- partial -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
    <script>
        var url = 'http://localhost:3000';
        var connected = false;
        let token = ""
        let socket;
        function login() {
            var username = document.getElementById("loginUsername").value;
            var password = document.getElementById("loginPassword").value;
            console.log(username)
            console.log(password)
            fetch(`${url}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'username': username,
                    'password': password
                })
            }).then(response => {
                console.log(response)
                return response.json();
            }).catch(error => {
                console.log('Error: ', error)
            }).then(data => {
                console.log(data)
                token = data['access_token']
                document.getElementById("registrationPage").style.display = "none";
                document.getElementById("signinPage").style.display = "none";
                document.getElementById("roomPage").style.display = "block";
            })
        }
        function register() {
            var username = document.getElementById("registerUsername").value;
            var password = document.getElementById("registerPassword").value;
            fetch(`${url}/users/new`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'username': username,
                    'password': password
                })
            }).then(response => {
                console.log(response)
                if (response.status == 201) {
                    alert('Registered successfully');
                    document.getElementById("registrationPage").style.display = "none";
                    document.getElementById("signinPage").style.display = "block";
                }
            }).catch(error => {
                console.log('Error: ', error)
            })
            // Implement user registration logic here
            // You may want to send the registration data to a server or store it locally
            // After registration, you can show the room selection page similar to the login flow
            // document.getElementById("registrationPage").style.display = "none";
            // document.getElementById("roomPage").style.display = "block";
            // document.getElementById("loggedInUsername").innerText = username;
        }

        function joinRoom() {
            socket = io('http://localhost:3000/rooms', {
                withCredentials: true,
                transports: ['websocket'],
                query: {
                    'token': token,
                    'type': 'new'
                }
            }); // Replace with your NestJS server URL

            socket.on("connected", (payload) => {
                console.log("Connected to Socket.IO");
                console.log(payload)
                user_id = payload.user_id
                socketId = payload.socket
                room = payload.room
                console.log(socketId)
                document.getElementById("roomPage").style.display = "none";
                document.getElementById("room").style.display = "block";
            });
            socket.on("message", (message) => {
                console.log(message);
            });
            socket.on("serverMessage", (payload) => {
                console.log(message);
                messages.innerHTML += `<div class="message my-message">${payload.text}</div>`
            });
        }
        const messages = document.getElementById("messages");
        const sendButton = document.getElementById("send");
        const messageInput = document.getElementById("message");
        sendButton.addEventListener("click", () => {
            const message = messageInput.value;
            socket.emit("clientMessage", {
                'text': message,
                'origin': 'chat',
                'userId': user_id,
                'clientId': socketId,
                'room': room
            });
            messageInput.value = "";
        });

        function showRegistrationPage() {
            console.log(document.getElementById("signinPage"))
            console.log(document.getElementById("registrationPage"))
            document.getElementById("signinPage").style.display = "none";
            document.getElementById("registrationPage").style.display = "block";
        }

    </script>

</body>

</html>